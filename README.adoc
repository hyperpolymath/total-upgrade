= TotalUpdate (with DNFinition)

image:https://img.shields.io/badge/license-AGPL--3.0-blue.svg[AGPL-3.0,link="https://www.gnu.org/licenses/agpl-3.0"] image:https://img.shields.io/badge/philosophy-Palimpsest-purple.svg[Palimpsest,link="https://github.com/hyperpolymath/palimpsest-licence"]
:toc: left
:toclevels: 3
:icons: font
:source-highlighter: rouge

TotalUpdate is a safety-focused updater: no system should be breached because
an available patch was not applied.
DNFinition is a standalone universal package manager/TUI used by TotalUpdate
but also usable on its own.

== Overview

This repository contains two complementary but *standalone* tools:

*TotalUpdate*:: Automated, safety-focused updater across package managers
*DNFinition*:: Interactive universal package manager with reversibility (nala/aptitude-style)

== Standalone + Combinations

* Install TotalUpdate alone for "never miss a patch" assurance
* Install DNFinition alone for a universal PM/TUI
* Combine for end-to-end safety (audit + reversibility)
* Combine with Total Recall for rollback guardrails
* Combine with feedback-a-tron for privacy-gated sharing
* No bundle required: install only what you need

Both are written in *Ada 2022* (TUI, formal verification) + *Elixir/OTP* (daemon, orchestration), designed for safety-critical package management.

== asdf Interoperability Policy

TotalUpdate integrates with asdf without taking over or modifying the asdf ecosystem.

* Uses asdf only when installed and explicitly enabled
* Reads `.tool-versions` to detect toolchains
* Does not install or upgrade plugins by default
* Does not modify asdf registry or plugin sources
* Logs all asdf operations for audit and rollback
* Offers opt-in write-back and automation

== Project Status

[cols="1,3"]
|===

== Production Guardrails

TotalUpdate should ship with a minimal rollback guard (snapshot or state vault)
to preserve trust if an update causes regressions. Total Recall provides the
full recovery workflow, but a minimal guard is required for early production.

== Micropatching (v2.0)

Micropatching is planned as an opt-in, uptime-focused mitigation.
Full patches remain the default, and paid services require explicit consent.

== Privacy-Gated Dependency Checks

TotalUpdate will generate dependency and compatibility reports and place them
in the feedback-a-tron outbox for user review. Nothing is submitted externally
until the user approves or redacts it.

== Idris2 Policy Gate

Outbound payloads are validated by the AmbientOps Idris2 checker before any
egress. See `docs/IDRIS2_INTEGRATION.adoc`.
|Phase |Foundation Development
|Version |0.1.0
|License |AGPL-3.0-or-later
|===

== Key Features

=== DNFinition Features

* *Unified Interface* - Single TUI for 50+ package managers
* *Reversibility Layer* - Every operation can be rolled back
** Native rollback for rpm-ostree, Nix, Guix, zypper
** Filesystem snapshots (btrfs, ZFS, LVM)
** Transaction logging fallback
* *Formal Verification* - SPARK proofs for safety-critical operations
* *Pretty Output* - Modern terminal interface like nala
* *Browse Mode* - Package exploration like aptitude

=== TotalUpdate Features

* *Universal Updates* - System packages, language packages, userscripts, browser extensions
* *Background Daemon* - Low-memory footprint (<5MB resident)
* *Strategy Engine* - Whitelist, blacklist, version pinning
* *Parallel Downloads* - aria2 integration
* *IPFS Distribution* - Decentralized package hosting

== Architecture

----
┌─────────────────────────────────────────────────────────────────┐
│                      TotalUpdate Daemon                         │
│                     (Elixir/OTP Supervisor)                     │
├─────────────────────────────────────────────────────────────────┤
│  Scheduler  │  Watcher  │  DownloadMgr  │  StrategyEngine      │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                    DNFinition Core (Ada)                        │
├─────────────────────────────────────────────────────────────────┤
│  Platform Detection  │  Backend Interface  │  Snapshot Manager │
├──────────────────────┴──────────────────────┴───────────────────┤
│                     TUI (ncurses)                               │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Package Manager Backends                       │
├─────────────┬─────────────┬─────────────┬───────────────────────┤
│ rpm-ostree  │     dnf     │     apt     │     pacman    │  ...  │
│   zypper    │     nix     │    guix     │    flatpak    │  ...  │
└─────────────┴─────────────┴─────────────┴───────────────────────┘
----

== Supported Package Managers

=== System Package Managers

[cols="3"]
|===
|*RPM-based*
|*DEB-based*
|*Other Linux*

|rpm-ostree, dnf, yum, zypper
|apt, nala, aptitude
|pacman, xbps, apk, portage

|*BSD*
|*macOS*
|*Windows*

|pkg (FreeBSD), pkg_add, pkgin
|Homebrew, MacPorts
|winget, Chocolatey, Scoop

|*Universal*
|*Immutable*
|

|Flatpak, Snap, AppImage
|Nix, Guix, rpm-ostree
|
|===

=== Language Package Managers

[cols="4"]
|===
|Deno |pip/pipx/poetry |cargo/rustup |hex/mix
|cabal |gem |composer |go modules
|===

== Quick Start

=== Prerequisites

[source,bash]
----
# Fedora/RHEL
sudo dnf install gcc-gnat gprbuild elixir aria2 ncurses-devel

# Debian/Ubuntu
sudo apt install gnat gprbuild elixir aria2 libncurses-dev

# Arch
sudo pacman -S gcc-ada gprbuild elixir aria2 ncurses
----

=== Build

[source,bash]
----
# Clone repository
git clone https://gitlab.com/hyperpolymath/totalupdate
cd totalupdate

# Check prerequisites
just prereqs

# Build everything
just build

# Run DNFinition
just run-dnfinition
----

=== Commands

[source,bash]
----
# Show available recipes
just

# Build in release mode
just build-release

# Run SPARK proofs
just prove

# Run tests
just test

# Install to ~/.local/bin
just install
----

== Usage

=== DNFinition CLI

[source,bash]
----
# Start interactive TUI
dnfinition

# Search for packages
dnfinition search firefox

# Install packages (creates snapshot first)
dnfinition install vim htop

# Upgrade all packages
dnfinition upgrade

# List snapshots
dnfinition snapshots

# Rollback to last snapshot
dnfinition rollback

# Rollback to specific snapshot
dnfinition rollback 5
----

=== TotalUpdate Configuration

[source,toml]
----
# ~/.config/totalupdate/config.toml

[global]
mode = "conservative"  # aggressive, conservative, manual
check_interval = "4h"
auto_apply = false

[whitelist]
always_update = ["firefox", "rust", "podman"]

[blacklist]
never_update = ["nvidia-drivers", "kernel"]

[version_pinning]
"node" = "20.x"
"python" = "3.11.*"
----

== Formal Verification

DNFinition uses SPARK for formal verification of safety-critical operations:

[source,ada]
----
procedure Rollback_To_Snapshot (ID : Snapshot_ID)
  with Pre  => Snapshot_ID_Valid (ID) and then
               Snapshot_Exists (ID),
       Post => System_State_Matches_Snapshot (ID);
----

Run proofs with:

[source,bash]
----
just prove
----

== Development

=== Directory Structure

----
totalupdate/
├── ada/
│   ├── dnfinition/           # DNFinition Ada sources
│   │   ├── dnfinition.gpr    # GNAT project
│   │   └── src/
│   │       ├── platform/     # Platform detection
│   │       ├── tui/          # ncurses interface
│   │       ├── backends/     # Package manager backends
│   │       ├── reversibility/# Snapshot management
│   │       └── formal/       # SPARK proofs
│   └── totalupdate/          # TotalUpdate Ada components
├── elixir/
│   ├── dnfinition/           # DNFinition OTP app
│   │   └── lib/
│   │       ├── application.ex
│   │       ├── ada_wrapper.ex
│   │       ├── snapshot_manager.ex
│   │       ├── transaction_log.ex
│   │       └── recovery.ex
│   └── totalupdate/          # TotalUpdate daemon
│       └── lib/
│           ├── application.ex
│           ├── daemon.ex
│           └── scheduler.ex
├── docs/
├── justfile
└── README.adoc
----

=== Contributing

See link:CONTRIBUTING.md[CONTRIBUTING.md] for guidelines.

== Roadmap

=== Phase 1: Foundation (Current)
* [x] Platform detection
* [x] Backend interface abstraction
* [x] Reversibility types and SPARK contracts
* [x] Elixir OTP skeleton
* [ ] ncurses TUI implementation
* [ ] First backend (rpm-ostree)

=== Phase 2: Core Features
* [ ] Snapshot manager (btrfs/ZFS/LVM)
* [ ] Transaction logging
* [ ] Rollback engine
* [ ] dnf/apt backends

=== Phase 3: TotalUpdate
* [ ] aria2 integration
* [ ] Background daemon
* [ ] Strategy engine
* [ ] IPFS support

=== Phase 4: Polish
* [ ] Cross-platform testing
* [ ] Full SPARK verification
* [ ] Documentation
* [ ] Container images

== License

link:LICENSE.txt[AGPL-3.0-or-later]

== Author

Jonathan D.A. Jewell <jonathan@hyperpolymath.io>

---

_TotalUpdate & DNFinition are maintained by https://github.com/hyperpolymath[Hyperpolymath]._
